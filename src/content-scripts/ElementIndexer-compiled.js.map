{"version":3,"sources":["ElementIndexer.es6"],"names":[],"mappings":"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","file":"ElementIndexer-compiled.js","sourcesContent":["/*\n * Copyright (c) 2016 Clint Priest\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the \"Software\"),\n * to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense,\n * and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE\n * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF\n * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER\n * DEALINGS IN THE SOFTWARE.\n */\n\n\n\"use strict\";\n\nclass RectMapper {\n\tconstructor() {\n\t\tthis.ElemRects = new WeakMap();\n\t}\n\n\t/**\n\t * Gets the elements bounding rect(s) in document coordinates\n\t *\n\t * @param elem    HtmlElement    The element being requested\n\t * @param offset  object        The {x,y} offset the document is currently scrolled to (passed for performance reasons)\n\t * @returns {Rect}\n\t */\n\tget(elem, offset) {\n\t\tlet Rects = this.ElemRects.get(elem);\n\t\tif(Rects)\n\t\t\treturn Rects;\n\n\t\tRects = this.GetElementRects(elem, offset);\n\t\tthis.ElemRects.set(elem, Rects);\n\t\treturn Rects;\n\t}\n\n\t/** Returns an array of { top, left, width, height } objects which combined make up the bounding rects of the given element,\n\t *    this uses the built-in .getClientRects() and additionally compensates for 'block' elements which it would appear is not\n\t *    handled appropriately for our needs by Mozilla or the standard\n\t */\n\tGetElementRects(elem, offset) {\n\t\toffset = offset || { x: 0, y: 0 };\n\n\t\tvar Rects = $A(elem.getClientRects());\n\n\t\t$A(elem.querySelectorAll('IMG')).forEach(function(elem) {\n\t\t\tRects = Rects.concat($A(elem.getClientRects()));\n\t\t}, this);\n\t\treturn Rects.map(function(rect) {\n\t\t\treturn new Rect(rect.top + offset.y, rect.left + offset.x,\n\t\t\t\trect.bottom + offset.y, rect.right + offset.x);\n\t\t});\n\t}\n}\n\n/**\n * This class is responsible for:\n *  - Identifying/Tracking which elements in the document are selectable\n *  - Quickly filtering selectable elements by a document coordinate rect\n */\nclass ElementIndexer {\n\tconstructor() {\n\t\tthis.Anchors      = document.querySelectorAll('A[href]');\n\t\tthis.ElementRects = new RectMapper();\n\n\t\tthis.UpdateIndex();\n\t}\n\n\tUpdateIndex() {\n\t\tlet start     = Date.now(),\n\t\t\telem, idx,\n\t\t\tdocElem   = document.documentElement,\n\t\t\tscrollTop = docElem.scrollTop,\n\t\t\tdocHeight = docElem.scrollHeight,\n\t\t\tBuckets   = data.IndexBuckets;\n\t\tlet offset    = { x: document.documentElement.scrollLeft, y: document.documentElement.scrollTop };\n\n\t\tthis.BoundaryIndex = [];\n\t\tfor(var j = 0; j < Buckets; j++)\n\t\t\tthis.BoundaryIndex[ j ] = [];\n\n//\t\t@PerfTest\n//\t\tvar rr = new RateReporter('Calculated ${Count} Elements in ${Elapsed} (${PerSecond})');\n\t\tfor(elem of this.Anchors) {\n\t\t\t/* GetBucketFromTop() */\n\t\t\tidx = Math.floor((elem.getBoundingClientRect().top + scrollTop) * Buckets / docHeight);\n\t\t\tif(this.BoundaryIndex[ idx ])\n\t\t\t\tthis.BoundaryIndex[ idx ].push(elem);\n//\t\t\t@PerfTest\n//\t\t\tthis.ElementRects.get(elem, offset);\n\t\t}\n//\t\t@PerfTest\n//\t\trr.report(this.Anchors.length);\n\t}\n\n\t/**\n\t *\n\t * @param SelectionRect\n\t */\n\tSearch(SelectionRect) {\n\t\tlet docHeight   = document.documentElement.scrollHeight,\n\t\t\tBuckets     = data.IndexBuckets,\n\t\t\t/* GetBucketFromTop() */\n\t\t\tFirstBucket = Math.floor(SelectionRect.top * Buckets / docHeight),\n\t\t\t/* GetBucketFromTop() */\n\t\t\tLastBucket  = Math.floor(SelectionRect.bottom * Buckets / docHeight),\n\t\t\toffset      = { x: document.documentElement.scrollLeft, y: document.documentElement.scrollTop },\n\t\t\ttMatches    = [];\n\n\t\tfor(var j = FirstBucket; j <= LastBucket; j++) {\n\t\t\tfor(var elem of this.BoundaryIndex[ j ]) {\n\t\t\t\tfor(var r of this.ElementRects.get(elem, offset)) {\n\t\t\t\t\tif(SelectionRect.intersects(r)) {\n\t\t\t\t\t\ttMatches.push(elem);\n\t\t\t\t\t\tbreak;\t// for(var r...\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn tMatches;\n\t}\n}\n\n"]}